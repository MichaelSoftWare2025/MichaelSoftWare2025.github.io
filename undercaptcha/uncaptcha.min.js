(function() {
    function generateCaptcha() {
        let text = "";
        let possible = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
        for (let i = 0; i < 6; i++) {
            text += possible.charAt(Math.floor(Math.random() * possible.length));
        }
        return text;
    }

    function generateCaptchaImage(text) {
        let canvas = document.createElement("canvas");
        canvas.width = 150;
        canvas.height = 50;
        let ctx = canvas.getContext("2d");
        ctx.fillStyle = "#e3e3e3";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.font = "30px Arial";
        ctx.fillStyle = "black";
        
        for (let i = 0; i < text.length; i++) {
            let x = 20 + i * 20;
            let y = 35 + Math.sin(i) * 5;
            ctx.save();
            ctx.translate(x, y);
            ctx.rotate((Math.random() * 0.3 - 0.15));
            ctx.fillText(text[i], 0, 0);
            ctx.restore();
        }
        return canvas.toDataURL("image/png");
    }

    function createCaptchaElement(container) {
        let captchaText = generateCaptcha();
        let imageSrc = generateCaptchaImage(captchaText);

        container.innerHTML = `
            <style>
                body {
                    font-family: Arial, sans-serif;
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    height: 100vh;
                    background-color: #f4f4f4;
                }
                .captcha-container {
                    background: white;
                    padding: 20px;
                    border-radius: 10px;
                    box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);
                    text-align: center;
                }
                .captcha-box {
                    display: flex;
                    align-items: center;
                    justify-content: space-between;
                    border: 1px solid #ccc;
                    padding: 10px;
                    background: #e3e3e3;
                    font-weight: bold;
                    font-size: 18px;
                    user-select: none;
                }
                .captcha-input {
                    width: 100%;
                    padding: 8px;
                    margin-top: 10px;
                    border: 1px solid #ccc;
                    border-radius: 5px;
                    font-size: 16px;
                }
                .captcha-buttons {
                    display: flex;
                    justify-content: space-between;
                    margin-top: 10px;
                }
                button {
                    padding: 10px;
                    border: none;
                    cursor: pointer;
                    border-radius: 5px;
                    font-size: 16px;
                }
                .refresh {
                    background: #007bff;
                    color: white;
                }
                .submit {
                    background: #28a745;
                    color: white;
                }
                .captcha-image {
                    background: white;
                    padding: 10px;
                    border-radius: 5px;
                    display: flex;
                    justify-content: center;
                    align-items: center;
                }
            </style>
            <div class="captcha-container">
                <h2>Verify you are human</h2>
                <div class="captcha-box">
                    <img class="captcha-image" src="${imageSrc}" alt="Captcha">
                    <button class="refresh">&#x21bb;</button>
                </div>
                <input type="text" class="captcha-input" placeholder="Enter the text above">
                <div class="captcha-buttons">
                    <button class="submit">Submit</button>
                </div>
            </div>
        `;

        let refreshButton = container.querySelector(".refresh");
        let submitButton = container.querySelector(".submit");
        let inputField = container.querySelector(".captcha-input");

        refreshButton.addEventListener("click", function() {
            captchaText = generateCaptcha();
            container.querySelector(".captcha-image").src = generateCaptchaImage(captchaText);
        });

        submitButton.addEventListener("click", function() {
            if (inputField.value.trim() === captchaText) {
                let url = container.getAttribute("url");
                if (url) window.location.href = url;
            } else {
                alert("Captcha is incorrect");
                captchaText = generateCaptcha();
                container.querySelector(".captcha-image").src = generateCaptchaImage(captchaText);
            }
        });
    }

    document.addEventListener("DOMContentLoaded", function() {
        let captchaContainers = document.querySelectorAll(".uncaptcha");
        captchaContainers.forEach(createCaptchaElement);
    });
})();
